<!--
You are free to copy and use this sample in accordance with the terms of the
Apache license (http://www.apache.org/licenses/LICENSE-2.0.html)
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>SUJ Geo walks</title>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
    <script type="text/javascript">

      var path = [];
      var map = null;
      var line = null;
      var drawn_circles = [];
      var step = 0;
      var count = 0;

      var test_circlesRAW = [
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6994996, 35.6657032]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 78.7013215693457]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6994996, 35.6657032]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 78.7013215693457]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6995782, 35.6656964]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 76.3514968720267]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6996389, 35.6657043]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 76.3514968720267]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6997016, 35.6663966]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 38.1757484360134]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.69991346, 35.66611394]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 60.3611582197065]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7002382, 35.6657324]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 42.6817842974286]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7006076, 35.6656308]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 38.1757484360134]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7008764, 35.6653847]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.701148533333, 35.6652515]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.701319066667, 35.6651729]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7014896, 35.6650943]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]},
        {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.701840625, 35.66485545]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]},
        {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.70219165, 35.6646166]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]},
        {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7023671625, 35.664497175]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]},
        {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.702542675, 35.66437775]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]},
        {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.7028937, 35.6641389]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 80.9829917879303]},
        {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7030126, 35.6644695]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 57.26362265402]},
        {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.703566466667, 35.6644245666667]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]},
        {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.70367915, 35.6642571]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 57.26362265402]},
        {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.7040172, 35.6637547]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]},
        {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.7043312, 35.6635739]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]},
        {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.70448932, 35.66347248]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 42.6817842974286]},
        {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.70480556, 35.66326964]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 85.3635685948572]},
        {"centers": [[139.703521728516, 35.6602478027344], [139.703521728516, 35.6629943847656], [139.703521728516, 35.6657409667969], [139.706268310547, 35.6629943847656]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 566.190087927757]},
        {"centers": [[139.711761474609, 35.6602478027344]], "radii": [566.190087927757]},
        {"centers": [[139.714508056641, 35.6629943847656]], "radii": [566.190087927757]}
      ];

      function getNewPath() {
        // Make ajax call
        var xhReq = new XMLHttpRequest();
        xhReq.open("GET", "/?lon="+$('.lon').val()+"&lat="+$('.lat').val()+"&length="+$('.length').val(), false);
        xhReq.send(null);
        var serverResponse = xhReq.responseText;
        var fakeResponse = '{"distance":0.01855711480024141,"body":[[139.6994996,35.6657032],[139.6995782,35.6656964],[139.6996389,35.6657043],[139.6997465,35.6657774],[139.6997016,35.6663966],[139.6997347,35.6665372],[139.6997568,35.666651],[139.7000179,35.6657559],[139.7001158,35.6657181],[139.7003606,35.6657467],[139.7004236,35.665742],[139.7004752,35.6657258],[139.7006076,35.6656308],[139.7008764,35.6653847],[139.700978,35.6653301],[139.7014896,35.6650943],[139.7028937,35.6641389],[139.7028797,35.6641606],[139.7028592,35.6642055],[139.7029078,35.6643141],[139.7029614,35.6644054],[139.7030126,35.6644695],[139.7030904,35.6645551],[139.7032603,35.6647376],[139.7033411,35.6647595],[139.7040172,35.6637547],[139.7043312,35.6635739],[139.7051218,35.6630668],[139.7053009,35.6629616],[139.7061349,35.6624272],[139.7066613,35.6621213],[139.7067103,35.6620935],[139.7070218,35.6619224],[139.7072794,35.6617521],[139.7073346,35.6617112],[139.7076152,35.6614438],[139.7077123,35.6613459],[139.7088832,35.6603396],[139.7097746,35.6605931],[139.7119626,35.6610383],[139.7121575,35.6608504],[139.7122463,35.6607751],[139.712342,35.6607127],[139.7124545,35.6606483],[139.7128499,35.6619697],[139.7129493,35.6620888],[139.7135611,35.6627148],[139.7142424,35.6634116],[139.714319,35.66349],[139.7146347,35.663813],[139.7146661,35.663846],[139.7167647,35.6633986],[139.7162431,35.6628494],[139.7146349,35.6622081],[139.7141657,35.6624447],[139.7141813,35.661293],[139.7136965,35.6606976],[139.7133211,35.6609076],[139.7137764,35.6614902]]}';
        var objJSON = JSON.parse(fakeResponse);

        // Update data
        path = [];
        objJSON['body'].forEach( function(p) {
          if (p) {
            path.push(new google.maps.LatLng(p[1],p[0]));
          }
          else{
            console.log(objJSON['body'])
          }
        });

        // Dumb refresh
        initialize();
        update_circles();
      }

      function initialize() {
        var mapDiv = document.getElementById('map-canvas');
        map = new google.maps.Map(mapDiv, {
          center: new google.maps.LatLng($('.lat').val(),$('.lon').val()),
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        var lineSymbol = {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
        };

        line = new google.maps.Polyline({
          path: path,
          icons: [{
            icon: lineSymbol,
            offset: '100%'
          }],
          strokeColor: '#ff0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
      
        google.maps.LatLng.prototype.kmTo = function(a){ 
          var e = Math, ra = e.PI/180; 
          var b = this.lat() * ra, c = a.lat() * ra, d = b - c; 
          var g = this.lng() * ra - a.lng() * ra; 
          var f = 2 * e.asin(e.sqrt(e.pow(e.sin(d/2), 2) + e.cos(b) * e.cos(c) * e.pow(e.sin(g/2), 2))); 
          return f * 6378.137; 
        } 
        
        var inKm = function(n){ 
          var a = n, len = a.length, dist = 0; 
          for(var i=0; i<len-1; i++){ 
            dist += a[i].kmTo(a[i+1]); 
          } 
          return dist; 
        } 
      
        $('.info').html("Route length: "+inKm(path).toPrecision(4)+" Km");
        line.setMap(map);
      }

      function animateArrow(sense) {
        //var count = 0;
        //offsetId = window.setInterval(function() {
          if (sense == -1) {
            count = (count - 1) % 200;
          }
          else {
            count = (count + 1) % 200;
          }

          var icons = line.get('icons');
          icons[0].offset = (count / 2) + '%';
          line.set('icons', icons);
        //}, 250);
      }


      function update_circles() {
        // Bounding check for buttons
        if (step < 0 ) {
          step = 0;
          return;
        }
        if (step >= test_circlesRAW.length ) {
          step = test_circlesRAW.length;
          return;
        }

        // Delete previous circles
        drawn_circles.forEach( function(c) {
          c.setMap(null);
        });

        // Draw each of the new circles
        var test_circles = test_circlesRAW[step];
        test_circles['centers'].forEach( function(p) {
          if (p) {
            point = new google.maps.LatLng(p[1],p[0]);

            // Draw circles
            var populationOptions = {
              strokeColor: "#FF0000",
              strokeOpacity: 0.6,
              strokeWeight: 1,
              fillColor: "#FF0000",
              fillOpacity: 0.35,
              map: map,
              center: point,
              radius: test_circles['radii'][test_circles['centers'].indexOf(p)]*0.81
            };
            var c = new google.maps.Circle(populationOptions);
            drawn_circles.push(c);

          }
          else{
            console.log(test_circles['centers'])
          }
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body style="font-family: Arial; border: 0 none;">
    <div id="map-canvas" style="width: 800px; height: 400px"></div>
    <div>
      Position: 
      <button onclick='animateArrow(-1);' type="button">&lt;</button>
      <button onclick='animateArrow(1);' type="button">&gt;</button>
      <br>
      Request:
      <button onclick='step -= 1; update_circles();' type="button">&lt;</button>
      <button onclick='step += 1; update_circles();' type="button">&gt;</button>
      <br>
      Lon: <input class="lon" type="text" name="lon" value="139.698345">
      Lat: <input class="lat" type="text" name="lat" value="35.666641">
      Length: <input class="length" type="text" name="length" value="2000">m
      <br>
      <input type="submit" onclick="getNewPath()" value="Get new route">
    </div>
    <div class="info"></div>
  </body>
</html>
