<!--
You are free to copy and use this sample in accordance with the terms of the
Apache license (http://www.apache.org/licenses/LICENSE-2.0.html)
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>SUJ Geo walks</title>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
    <script type="text/javascript">

      var path = [];
      var map = null;
      var line = null;
      var drawn_circles = [];
      var step = 0;
      var count = 0;
      var sim_debug = true;

      var test_circlesRAW = [{"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6994996, 35.6657032]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 78.7013215693457]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6994996, 35.6657032]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 78.7013215693457]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6995782, 35.6656964]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 76.3514968720267]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6996389, 35.6657043]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 76.3514968720267]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.6997016, 35.6663966]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 38.1757484360134]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.69991346, 35.66611394]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 60.3611582197065]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7002382, 35.6657324]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 42.6817842974286]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7006076, 35.6656308]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 38.1757484360134]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7008764, 35.6653847]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.701148533333, 35.6652515]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.701319066667, 35.6651729]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7014896, 35.6650943]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]}, {"centers": [[139.698028564453, 35.6629943847656], [139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.698028564453, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.701840625, 35.66485545]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]}, {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.70219165, 35.6646166]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]}, {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7023671625, 35.664497175]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]}, {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.702542675, 35.66437775]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]}, {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.7028937, 35.6641389]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 80.9829917879303]}, {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.7030126, 35.6644695]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 57.26362265402]}, {"centers": [[139.700775146484, 35.6629943847656], [139.703521728516, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.700775146484, 35.6684875488281], [139.703521728516, 35.6684875488281], [139.703566466667, 35.6644245666667]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]}, {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.70367915, 35.6642571]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 57.26362265402]}, {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.7040172, 35.6637547]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 26.9943305959768]}, {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.7043312, 35.6635739]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 19.0878742180067]}, {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.70448932, 35.66347248]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 42.6817842974286]}, {"centers": [[139.700775146484, 35.6602478027344], [139.703521728516, 35.6602478027344], [139.700775146484, 35.6629943847656], [139.700775146484, 35.6657409667969], [139.703521728516, 35.6657409667969], [139.70480556, 35.66326964]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 188.730029309252, 85.3635685948572]}, {"centers": [[139.703521728516, 35.6602478027344], [139.703521728516, 35.6629943847656], [139.703521728516, 35.6657409667969], [139.706268310547, 35.6629943847656]], "radii": [188.730029309252, 188.730029309252, 188.730029309252, 566.190087927757]}, {"centers": [[139.711761474609, 35.6602478027344]], "radii": [566.190087927757]}, {"centers": [[139.714508056641, 35.6629943847656]], "radii": [566.190087927757]}];

      function getNewPath() {
        // Make ajax call
        var xhReq = new XMLHttpRequest();
        xhReq.open("GET", "/?lon="+$('.lon').val()+"&lat="+$('.lat').val()+"&length="+$('.length').val(), false);
        xhReq.send(null);
        var serverResponse = xhReq.responseText;
        var fakeResponse = {"distance":0.022440991828881172,"body":[[138.908731,35.954213],[138.908872,35.954172],[138.909093,35.954027],[138.909232,35.953973],[138.909409,35.954003],[138.90966,35.95407],[138.90983,35.954082],[138.910096,35.954009],[138.910642,35.953805],[138.911425,35.953553],[138.9118159,35.95341],[138.912052,35.953265],[138.9122889,35.953073],[138.91265,35.9526899],[138.913161,35.952181],[138.913117,35.950109],[138.912884,35.950126],[138.912842,35.950125],[138.912824,35.950121],[138.912802,35.950109],[138.912702,35.950021],[138.912484,35.949803],[138.912031,35.948923],[138.911984,35.948809],[138.911956,35.948743],[138.9131717,35.9496522],[138.912903,35.9497115],[138.9127825,35.9496705],[138.9118566,35.9482396],[138.9119103,35.9479],[138.9118944,35.9477652],[138.9116248,35.9472132],[138.9114996,35.9470342],[138.9113869,35.9468729],[138.9113235,35.9467061],[138.9114424,35.9465584],[138.9121501,35.9458555],[138.9125763,35.9450129],[138.9125268,35.9448524],[138.9122592,35.9444994],[138.9115951,35.9444593],[138.911268,35.944363],[138.9109905,35.9439938],[138.9108814,35.9439296],[138.9106151,35.9436733],[138.9105059,35.9436291],[138.9104122,35.943627],[138.910303,35.943672]]};
        if (sim_debug) {
          var objJSON = fakeResponse;
        }
        else {
          var objJSON = JSON.parse(serverResponse);
        }

        // Update data
        path = [];
        objJSON['body'].forEach( function(p) {
          if (p) {
            path.push(new google.maps.LatLng(p[1],p[0]));
          }
          else{
            console.log(objJSON['body'])
          }
        });

        // Dumb refresh
        initialize();
        if (sim_debug) {
          update_circles();
        }
      }

      function initialize() {
        var mapDiv = document.getElementById('map-canvas');
        map = new google.maps.Map(mapDiv, {
          center: new google.maps.LatLng($('.lat').val(),$('.lon').val()),
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        var lineSymbol = {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
        };

        line = new google.maps.Polyline({
          path: path,
          icons: [{
            icon: lineSymbol,
            offset: '100%'
          }],
          strokeColor: '#ff0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
      
        google.maps.LatLng.prototype.kmTo = function(a){ 
          var e = Math, ra = e.PI/180; 
          var b = this.lat() * ra, c = a.lat() * ra, d = b - c; 
          var g = this.lng() * ra - a.lng() * ra; 
          var f = 2 * e.asin(e.sqrt(e.pow(e.sin(d/2), 2) + e.cos(b) * e.cos(c) * e.pow(e.sin(g/2), 2))); 
          return f * 6378.137; 
        } 
        
        var inKm = function(n){ 
          var a = n, len = a.length, dist = 0; 
          for(var i=0; i<len-1; i++){ 
            dist += a[i].kmTo(a[i+1]); 
          } 
          return dist; 
        } 
      
        $('.info').html("Route length: "+inKm(path).toPrecision(4)+" Km");
        line.setMap(map);
      }

      function animateArrow(sense) {
        //var count = 0;
        //offsetId = window.setInterval(function() {
          if (sense == -1) {
            count = (count - 1) % 200;
          }
          else {
            count = (count + 1) % 200;
          }

          var icons = line.get('icons');
          icons[0].offset = (count / 2) + '%';
          line.set('icons', icons);
        //}, 250);
      }


      function update_circles() {
        // Bounding check for buttons
        if (step < 0 ) {
          step = 0;
          return;
        }
        if (step >= test_circlesRAW.length ) {
          step = test_circlesRAW.length;
          return;
        }

        // Delete previous circles
        drawn_circles.forEach( function(c) {
          c.setMap(null);
        });

        // Draw each of the new circles
        var test_circles = test_circlesRAW[step];
        test_circles['centers'].forEach( function(p) {
          if (p) {
            point = new google.maps.LatLng(p[1],p[0]);

            // Draw circles
            var populationOptions = {
              strokeColor: "#FF0000",
              strokeOpacity: 0.6,
              strokeWeight: 1,
              fillColor: "#FF0000",
              fillOpacity: 0.35,
              map: map,
              center: point,
              radius: test_circles['radii'][test_circles['centers'].indexOf(p)]*0.81
            };
            var c = new google.maps.Circle(populationOptions);
            drawn_circles.push(c);

          }
          else{
            console.log(test_circles['centers'])
          }
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body style="font-family: Arial; border: 0 none;">
    <div id="map-canvas" style="width: 800px; height: 400px"></div>
    <div>
      Position: 
      <button onclick='animateArrow(-1);' type="button">&lt;</button>
      <button onclick='animateArrow(1);' type="button">&gt;</button>
      <br>
      Request:
      <button onclick='if (sim_debug) { step -= 1; update_circles();} else {console.log("Please enable debug mode")}' type="button">&lt;</button>
      <button onclick='if (sim_debug) { step += 1; update_circles();} else {console.log("Please enable debug mode")}' type="button">&gt;</button>
      <br>
      Lon: <input class="lon" type="text" name="lon" value="139.698345">
      Lat: <input class="lat" type="text" name="lat" value="35.666641">
      Length: <input class="length" type="text" name="length" value="2000">m
      <br>
      <input type="submit" onclick="getNewPath()" value="Get new route">
    </div>
    <div class="info"></div>
  </body>
</html>
